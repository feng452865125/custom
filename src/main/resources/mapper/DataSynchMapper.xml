<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.chunhe.custom.pc.mapper.DataSynchMapper">
    <resultMap id="BaseResultMap" type="com.chunhe.custom.pc.model.DataSynch">
        <!--
          WARNING - @mbg.generated
        -->
        <id column="id" jdbcType="INTEGER" property="id"/>
        <result column="name" jdbcType="VARCHAR" property="name"/>
        <result column="type" jdbcType="INTEGER" property="type"/>
        <result column="resource" jdbcType="VARCHAR" property="resource"/>
        <result column="create_date" jdbcType="TIMESTAMP" property="createDate"/>
        <result column="update_date" jdbcType="TIMESTAMP" property="updateDate"/>
        <result column="expire_date" jdbcType="TIMESTAMP" property="expireDate"/>
        <result column="user_code" jdbcType="VARCHAR" property="userCode"/>
    </resultMap>
    <sql id="Base_Column_List">
        <!--
          WARNING - @mbg.generated
        -->
        ds.`id` as `ds_id`, ds.`name` as `ds_name`, ds.`type` as `ds_type`, ds.`resource` as `ds_resource`,
        ds.`create_date` as `ds_create_date`, ds.`update_date` as `ds_update_date`, ds.`expire_date` as
        `ds_expire_date`,
        ds.`user_code` as `ds_user_code`
    </sql>

    <select id="findDataSynchOrderByTypeList" resultMap="BaseResultMap">
        SELECT `id`, `name`, resource,
        SUBSTRING_INDEX(group_concat(`user_code` ORDER BY create_date DESC ), ',', 1) AS `user_code`,
        SUBSTRING_INDEX(group_concat(`type` ORDER BY create_date DESC ), ',', 1) AS `type`,
        SUBSTRING_INDEX(group_concat(`create_date` ORDER BY create_date DESC),',',1) AS `create_date`
        FROM `data_synch`
        <where>
            1=1
            and expire_date is null
            GROUP BY `type`
            <if test="orderBy != null">
                order by ${orderBy}
            </if>
        </where>
    </select>

    <select id="getDataSynch" resultMap="BaseResultMap">
        SELECT ds.* FROM `data_synch` ds
        <where>
            1=1
            and ds.expire_date is null
            <if test="id != null">
                and ds.id = #{id}
            </if>
            order by ds.create_date desc
        </where>
    </select>

    <select id="findDataSynchList" resultMap="BaseResultMap">
        SELECT ds.* FROM `data_synch` ds,
        (SELECT `type`, `resource` FROM data_synch
        <where>
            1=1
            and expire_date is null
            <if test="id != null">
                and id = #{id}
            </if>
        </where>
        ) as dsy
        <where>
            1=1
            and ds.expire_date is null
            and ds.type = dsy.type
            and ds.resource = dsy.resource
            <if test="orderBy != null">
                order by ${orderBy}
            </if>
        </where>
    </select>

</mapper>